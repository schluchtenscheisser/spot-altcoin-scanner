name: ğŸ—ºï¸ Auto-Update Code Map with Call Graph

on:
  push:
    branches: [ main ]
    paths:
      - 'scanner/**/*.py'
      - 'tests/**/*.py'
      - 'scripts/update_codemap.py'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-codemap:
    runs-on: ubuntu-latest
    
    # Prevent infinite loop
    if: ${{ !contains(github.event.head_commit.message, 'Auto-update code map') }}
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ” Verify Script Exists
        run: |
          if [ ! -f scripts/update_codemap.py ]; then
            echo "âŒ scripts/update_codemap.py not found!"
            exit 1
          fi
          echo "âœ… Script found"
      
      - name: ğŸ§© Generate Code Map with Call Graph
        run: |
          echo "ğŸ—ºï¸  Running Code Map Generator..."
          python scripts/update_codemap.py
      
      - name: ğŸ“Š Check Generated File
        run: |
          if [ -f docs/code_map.md ]; then
            SIZE=$(wc -c < docs/code_map.md)
            LINES=$(wc -l < docs/code_map.md)
            echo "âœ… Code Map generated successfully"
            echo "   Size: ${SIZE} bytes"
            echo "   Lines: ${LINES}"
          else
            echo "âŒ docs/code_map.md not found!"
            exit 1
          fi
      
      - name: ğŸ” Check for Changes
        id: check_changes
        run: |
          if git diff --quiet docs/code_map.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Code Map is already up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected in Code Map"
            echo ""
            echo "Summary of changes:"
            git diff --stat docs/code_map.md
          fi
      
      - name: ğŸ“¤ Commit and Push Changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/code_map.md
          git commit -m "ğŸ¤– Auto-update code map with call graph analysis"
          
          # Fetch latest and rebase to avoid conflicts
          echo "ğŸ“¥ Fetching latest main..."
          git fetch origin main
          
          echo "ğŸ”„ Rebasing onto latest main..."
          git rebase origin/main || {
            echo "âš ï¸  Rebase conflict detected"
            echo "   Attempting to resolve..."
            git rebase --skip || {
              echo "âŒ Could not resolve rebase conflict"
              exit 1
            }
          }
          
          echo "ğŸš€ Pushing to main..."
          git push origin HEAD:main
          
          echo "âœ… Code Map successfully updated and pushed"
      
      - name: ğŸ“Š Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… Code Map has been updated with call graph analysis"
            echo ""
            echo "New features in Code Map:"
            echo "  â€¢ Module structure overview"
            echo "  â€¢ Function dependencies (who calls whom)"
            echo "  â€¢ Internal vs. external call separation"
            echo "  â€¢ Coupling statistics with refactoring insights"
          else
            echo "âœ… Code Map was already up to date"
            echo "   No changes needed"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

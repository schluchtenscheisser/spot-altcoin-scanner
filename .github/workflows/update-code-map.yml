name: ğŸ—ºï¸ Auto-Update Code Map with Call Graph

on:
  # Run after GPT Snapshot workflow completes
  workflow_run:
    workflows: ["gpt-snapshot"]
    types: [completed]
    branches: [main]
  
  # Also allow manual trigger
  workflow_dispatch:
  
  # Trigger on direct changes to Python files (but not after auto-commits)
  push:
    branches: [main]
    paths:
      - 'scanner/**/*.py'
      - 'tests/**/*.py'
      - 'scripts/update_codemap.py'

permissions:
  contents: write

jobs:
  update-codemap:
    runs-on: ubuntu-latest
    
    # Prevent infinite loop - skip if this is an auto-commit
    if: |
      !contains(github.event.head_commit.message, 'Auto-update code map') &&
      !contains(github.event.head_commit.message, '[skip ci]')
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use a token that can trigger other workflows if needed
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Ensure this run is tip of main (skip if outdated)
        run: |
          git fetch origin main --quiet
          TIP="$(git rev-parse origin/main)"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            EVENT="${{ github.event.workflow_run.head_sha }}"
          else
            EVENT="${GITHUB_SHA}"
          fi
          echo "TIP=$TIP"
          echo "EVENT=$EVENT"
          if [ "$TIP" != "$EVENT" ]; then
            echo "Outdated run (not tip of main). Skipping commit."
            exit 0
          fi
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: ğŸ“‹ Verify Script Exists
        run: |
          if [ ! -f scripts/update_codemap.py ]; then
            echo "âŒ scripts/update_codemap.py not found!"
            exit 1
          fi
          echo "âœ… Script found"
      
      - name: ğŸ§© Generate Code Map with Call Graph
        run: |
          echo "ğŸ—ºï¸  Running Code Map Generator..."
          python scripts/update_codemap.py
      
      - name: ğŸ“Š Check Generated File
        run: |
          if [ -f docs/code_map.md ]; then
            SIZE=$(wc -c < docs/code_map.md)
            LINES=$(wc -l < docs/code_map.md)
            echo "âœ… Code Map generated successfully"
            echo "   Size: ${SIZE} bytes"
            echo "   Lines: ${LINES}"
          else
            echo "âŒ docs/code_map.md not found!"
            exit 1
          fi
      
      - name: ğŸ” Check for Changes
        id: check_changes
        run: |
          if git diff --quiet docs/code_map.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Code Map is already up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected in Code Map"
            echo ""
            echo "Summary of changes:"
            git diff --stat docs/code_map.md
          fi
      
      - name: ğŸ“¤ Commit and Push Changes
        if: steps.check_changes.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Auto-update code map with call graph analysis [skip ci]"
          file_pattern: docs/code_map.md
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          skip_fetch: false
          skip_checkout: false
      
      - name: ğŸ“Š Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… Code Map has been updated with call graph analysis"
            echo ""
            echo "New features in Code Map:"
            echo "  â€¢ Module structure overview"
            echo "  â€¢ Function dependencies (who calls whom)"
            echo "  â€¢ Internal vs. external call separation"
            echo "  â€¢ Coupling statistics with refactoring insights"
          else
            echo "âœ… Code Map was already up to date"
            echo "   No changes needed"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
